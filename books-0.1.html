<html>

<head>
  <Title>Books of the Bible</Title>

  <script src="updateTable.js"></script>
</head>

<body>
  <H1>Books of the Bible</H1>

  <p id="context">
    In <b>BibleModel</b> initialization of the class <b>Bible</b> stage 2 of the state machine reads a database and
    creates a json file named <STRONG>books.json</STRONG>.
  </p>

  <p id="what">
    This page simply reads that in and displays it as a Table.
  <p>
  <h2>The raw data file <a href="books.json">books.json:</a> </h2>

  <p>
  <h2>This is where the table should go.</h2>

  <table id="booksTable">

  </table>

  <script> // type="module">

    const filePath = './books.json';
    console.log('Attempting to read books.json');

    async function fetchBooks() {
      console.log(`Fetching`);

      const url = "https://bible.michaelkentburns.com/dashboard/MKB/Bible/BibleModel/" + filePath;
      let response = undefined;
      try {
          response = await fetch(url, {
          mode: 'no-cors',
          method: 'GET',
             headers: {
                          accept: '*'
                       // accept: 'application/json',
                       // accept: 'application/text'
                      },
        });
      } catch (error) {
        console.log('There was an error fetching the json file: ', error);
        console.log('response is: ', response);
      }

      //  if (!response.ok) {
      //    throw new Error(`Error! status: ${response.status}`);
      //  }

      const books = await response.json();
      console.log(books);
      return books;
    }

    function readBooksDirect() {
        let allBooks;
        const fs = require('fs');
        const booksPath = './books.json';
        if (fs.existsSync(booksPath)) {
          const booksData = fs.readFileSync(booksPath, (error) => {
            if (error) {
              console.log('An error has occurred reading books', error);
              return;
            }
            if (traceBook) console.log('Books data read successfully from disk');
          });

          if (booksData != undefined && booksData.length > 2) {
            allBooks = JSON.parse(booksData);
          }
        }
        return allBooks;
      }

      // https://www.w3schools.com/js/js_api_fetch.asp
      // I cant even begin to understand how this is supposed to work.
      function fetchApiFile() {
        fetch (file)
          .then(jsText => jsText.text());
      }

      books = undefined;
      fetch(filePath)
        .then( x => booksFetched = x );
        console.log("booksFetched",booksFetched);
       
      console.log('we fetched ', booksFetched );
     // import books from filePath; // assert {type: 'json'};
      if (books == undefined)
        books = readBooksDirect();
      if (books == undefined)
        books = fetchBooks();
      updateTable("booksTable", fetchBooks());
  </script>

</body>

</html>