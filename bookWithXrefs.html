<html>

<head>
  <Title>One single book of the Bible with Cross References</Title>
  <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
</head>

<body>
  <H1>One single Book of the Bible with Cross References</H1>

  <p id="context">
    In <b>BibleModel</b> a program can now fetch an entire book of the Bible, 
    with or without the actual chapter and verse text. 
  </p>

  <p id="what">
    This page simply reads that in and displays it as a Table and Text.
  <p>

  <p>
  <h2>One book of the Bible.</h2>
  	<table id="bookTable">
 	</table>

  <div id="BookDiv">
     <p id="bookIntro"></p>
     <p id="bookText"></p>
  </div>


  <h2>JSON Data read from books.json:</h2>
    	<p id="bookJson">
    	</p>

  <script type="module">

     let booksArrayLocal = [];

     // ------- Read the table of books ----------------------
      const booksJsonPathname = "./books.json";
      let booksText = 'initialized text';
      let booksParagraphElement = document.getElementById('booksParagraph');
      let booksTableElement = document.getElementById('booksTable');
      let booksError;
      let enable = true;
      if (enable == true) {
        try {
          console.log('Next step is to fetch books.json file.');
          await fetch(booksJsonPathname,
                  {
                    mode: 'no-cors'
                  }
          ).then((response) => response.json())
                  .then((booksResult) => {
                    console.log("booksJSON=", booksArrayLocal);
                    booksArrayLocal = booksResult;
                    booksText = JSON.stringify(booksArrayLocal);
                  });
        } catch (error) {
          console.log("Error trying to fetch books.json: ", error);
          booksError = JSON.stringify(error);
          console.log("Error fetching file ", booksJsonPathname, " : ", booksError);
        }

      } else
        console.log('fetch disabled.');

      //--------- a simple function to find the name for a number
    function bookNumberToName(bookNumber) {
      for ( var eachBook of booksArrayLocal ) {
        if (eachBook.bookNumber == bookNumber)
          return eachBook.name;
      }
      return bookNumber;
    }

    //--------------- fetch the specific book json ------------------
    let booksArray = booksArrayLocal;

    let trace = true;
    // - - - - Look for book selection and other details in the URL options.
    let book = "Acts";
    let details = "contents";
    let source = "file";

    let url = document.URL;
    if ( trace ) console.log("URL="+url);
    let urlOptions = url.split('?')[1];
    if ( trace ) console.log("URL options="+urlOptions);
    if (urlOptions != undefined) {

    let optionArray = urlOptions.split('&');
    if ( trace ) console.log("URL option array="+optionArray);

    for (let i = 0; i < optionArray.length; i++) {
      let item = optionArray[i].split('=');
      if ( item[0] === "book" ) {
        book = item[1];
      }
      else if ( item[0] === "details" ) {
        details = item[1];
      }
      else if ( item[0] === "source" ) {
        source = item[1];
      }
    }
    // trace the query arguments
    if ( trace ) console.log("book="+book+" details="+details+" source="+source);
    }

    const bookJsonPathname = "./defaultBible/"+book+".json";
    const bookJsonURL = "http://localhost:3001/book/"+book+"/contents";
    //- - - - - - find placemarkers for insertion of the results
    let bookJsonElement = document.getElementById('bookJson');
    let bookTableElement = document.getElementById('bookTable');
    let bookError;
    let target = null;
    // - - - decide how to access both the file and from the rest server
    if ( source == null || source == "file" ) {
      target = bookJsonPathname;
    } else {  // for now assume URL for the server.
      target = bookJsonURL;
    }
    console.log("target=" + target);

    // - - - - - Go get the data - - - - - -
     let bookJsonData;
     let bookJsonText;
    if (enable == true) {
      try {
        console.log(`Next step is to fetch the data from ${target}.`);
         await fetch(target,
                {
                  mode: 'no-cors',
                  method: "GET"
                }
        ).then((response) => response.json())
                .then((bookResult) =>
                {
                  console.log("JSON=", bookResult);
                  bookJsonData = bookResult;
                  bookJsonText = JSON.stringify(bookJsonData);
                });
      } catch(error) {
        console.log("Error trying to fetch books.json: ",error);
        bookError = JSON.stringify(error);
        console.log("Error fetching ", target, " : ", bookError);
      }

    }
    else
      console.log('fetch disabled.');

    // Display the results on the web page.
    bookJsonElement.innerHTML = bookJsonText;

    // source of information
    let bookData = bookJsonData;
    let bookChapters = bookData.chapters;

    // destination of information
    let bookDivElement = document.getElementById("BookDiv");
    let bookIntroElement = document.getElementById("bookIntro");
    let bookHeaderElement = document.createElement("h2");
        bookIntroElement.appendChild(bookHeaderElement);
    let bookNameElement = document.createTextNode(bookData.name + " : " + bookData.title);
    let bookTitleHeaderElement = document.createElement("h2");
        bookTitleHeaderElement.appendChild(bookNameElement);
        bookIntroElement.appendChild(bookTitleHeaderElement);

    let bookTextElement = document.getElementById("bookText");

    bookData.chapters.forEach( (chap) => {
       let header2 = document.createElement("h3");
       header2.appendChild( document.createTextNode("Chapter " + chap.chapterNumber) );
       bookTextElement.appendChild(header2);
       let verses = chap.verses;
       verses.forEach( (verse) => {
         let xrefs = verse.xrefs;
         let vn = verse.verseNumber;
         let vt = verse.text;
         let boldVerseNumberElement = document.createElement("STRONG");
         boldVerseNumberElement.appendChild( document.createTextNode(vn + " "));
         bookTextElement.appendChild(boldVerseNumberElement);
         bookTextElement.appendChild(document.createTextNode(vt));
        // bookTextElement.appendChild( document.createElement("br") );
         if ( xrefs.length > 0 ) {
           let disclosureElement = document.createElement("details");
           disclosureElement.appendChild(document.createElement("summary")
                   .appendChild(document.createTextNode("Cross References")));
           xrefs.forEach( (xref) => {
             disclosureElement.appendChild( document.createTextNode(
                     "    [" +
                     xref.xrefNumber + "="+
                     bookNumberToName(xref.targetBook)+" " +
                     xref.targetChapter + ":" +
                     xref.targetVerse ));
             if ( xref.targetEndId > 0 ) {
               disclosureElement.appendChild( document.createTextNode(
                       "-"+
                    //   xref.targetEndBook+" " +
                       xref.targetEndChapter + ":" +
                       xref.targetEndVerse ));
             }
             disclosureElement.appendChild( document.createTextNode("]"));
           });
           bookTextElement.appendChild( disclosureElement);
          // bookTextElement.appendChild( document.createElement("br") );
         }
       });
    } );

  </script>

</body>

</html>
